<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GoSight Dashboard</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    h2 {
      font-size: 1.4rem;
      margin-top: 2rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.2rem;
    }
    #lastUpdate {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 0.5rem;
      overflow: hidden;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
    }
    th {
      background-color: #f1f1f1;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background-color: #fafafa;
    }
    td.value {
      transition: background-color 0.3s ease;
    }
    .high {
      background-color: #ffe5e5;
      color: #b30000;
    }
    .low {
      background-color: #e5ffe5;
      color: #006600;
    }
    .state-badge {
      display: inline-block;
      font-size: 0.8rem;
      padding: 0.1em 0.4em;
      border-radius: 0.25rem;
      margin-left: 0.5rem;
      text-transform: uppercase;
    }
    .running {
      background-color: #e5ffe5;
      color: #006600;
    }
    .exited {
      background-color: #ffe5e5;
      color: #b30000;
    }
  </style>
</head>
<body>
  <h1>GoSight System Metrics</h1>
  <h4>Written by Aaron Mathis - a man married to the most beautiful and amazing woman on the planet...</h4>
  <div id="lastUpdate">Waiting for data...</div>
  <div id="metricsTables"></div>

  <script>
    const ws = new WebSocket("ws://" + location.host + "/ws");
    const lastUpdate = document.getElementById("lastUpdate");
    const container = document.getElementById("metricsTables");

    ws.onmessage = (event) => {
      const { metrics, thresholds, meta } = JSON.parse(event.data);
      container.innerHTML = "";
      
      // Parse and log metadata (for future use)
      for (const key in meta) {
        const value = meta[key];

        if (key.startsWith("container_podman_state_")) {
          const container = key.replace("container_podman_state_", "");
          console.debug(`[META] state for ${container}: ${value}`);
        }

        if (key.startsWith("container_podman_image_")) {
          const container = key.replace("container_podman_image_", "");
          console.debug(`[META] image for ${container}: ${value}`);
        }

        if (key.startsWith("container_podman_restart_count_")) {
          const container = key.replace("container_podman_restart_count_", "");
          console.debug(`[META] restarts for ${container}: ${value}`);
        }
      }
      const grouped = {};

      for (const key of Object.keys(metrics)) {
        const value = metrics[key];

        if (key.startsWith("container_podman_")) {
          const parts = key.split("_");
          const containerName = parts.slice(-1)[0];
          const metric = parts.slice(2, -1).join("_");

          if (!grouped[containerName]) grouped[containerName] = [];
          grouped[containerName].push({ name: metric, full: key, value });
        } else {
          if (!grouped["HOST"]) grouped["HOST"] = [];
          grouped["HOST"].push({ name: key, full: key, value });
        }
      }

      for (const group in grouped) {
        const section = document.createElement("section");
        const header = document.createElement("h2");

        // Show container state from meta
        if (group !== "HOST") {
          const stateKey = `container_podman_state_${group}`;
          const state = meta[stateKey];
          header.textContent = group;
          if (state) {
            const badge = document.createElement("span");
            badge.className = `state-badge ${state.toLowerCase()}`;
            badge.textContent = state;
            header.appendChild(badge);
          }
        } else {
          header.textContent = group;
        }

        section.appendChild(header);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Metric</th><th>Value</th></tr>";
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        grouped[group].sort((a, b) => a.name.localeCompare(b.name)).forEach(({ name, full, value }) => {
          let cls = "";
          if (thresholds && thresholds[full]) {
            const t = thresholds[full];
            const high = parseFloat(t.high);
            const low = parseFloat(t.low);
            if (!isNaN(high) && value > high) cls = "high";
            else if (!isNaN(low) && value < low) cls = "low";
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${name}</td>
            <td class="value ${cls}">${value.toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        section.appendChild(table);
        container.appendChild(section);
      }

      lastUpdate.textContent = "Last updated: " + new Date().toLocaleTimeString();
    };

    ws.onerror = (e) => console.error("WebSocket error:", e);
  </script>
</body>
</html>
